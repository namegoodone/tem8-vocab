<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>专八词汇·消灭系统 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            /* 兼容 Safari 刘海屏安全距离 */
            --safe-top: env(safe-area-inset-top, 0px);
        }
        body { font-family: system-ui, sans-serif; background-color: #f1f5f9; padding-top: var(--safe-top); }
        
        /* 侧边栏布局修复 */
        .sidebar { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100; width: 320px; }
        @media (max-width: 1024px) {
            .sidebar { position: fixed; height: 100vh; transform: translateX(-100%); top: 0; left: 0; }
            .sidebar.open { transform: translateX(0); }
            .sidebar-content { padding-top: calc(85px + var(--safe-top)); }
        }

        /* 抬头 Safari 适配 */
        .sticky-header {
            top: 0;
            padding-top: var(--safe-top);
            z-index: 40;
        }

        .main-content { height: 100vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        
        /* 勾选掌握动画 */
        .card-mastered-anim { 
            animation: masteredOut 0.5s forwards cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }
        @keyframes masteredOut {
            0% { transform: scale(1); background-color: white; }
            30% { transform: scale(1.05); background-color: #d1fae5; border-color: #10b981; }
            100% { transform: translateX(120%) rotate(5deg); opacity: 0; }
        }

        .review-mode .blur-content { filter: blur(25px); transition: filter 0.3s; cursor: pointer; }
        .review-mode .blur-content.active { filter: blur(0); }
    </style>
</head>
<body class="flex overflow-hidden">

    <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 z-[90] hidden lg:hidden"></div>

    <aside id="sidebar" class="sidebar bg-white border-r border-slate-200 flex flex-col shrink-0 shadow-2xl lg:shadow-none">
        <div class="p-6 border-b bg-white sticky top-0 z-20 shadow-sm" style="padding-top: calc(1.5rem + var(--safe-top))">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-black text-slate-800">学习进度</h2>
                <button onclick="location.reload()" class="text-[10px] bg-slate-100 px-2 py-1 rounded-lg">刷新</button>
            </div>
            <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden mb-4 border border-slate-200">
                <div id="totalBar" class="bg-blue-600 h-full transition-all duration-700" style="width: 0%"></div>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="syncCopy()" class="bg-blue-600 text-white py-2 rounded-xl text-[10px] font-bold shadow-md">同步导出</button>
                <button id="importBtn" onclick="syncPasteSmart()" class="bg-slate-800 text-white py-2 rounded-xl text-[10px] font-bold shadow-md">导入进度</button>
            </div>
        </div>
        
        <div id="chapterStats" class="sidebar-content flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 pb-20">
            </div>
    </aside>

    <main class="main-content flex-1 flex flex-col min-w-0" id="scrollContainer">
        <header class="sticky-header bg-white/95 backdrop-blur-md border-b p-4 flex items-center justify-between sticky top-0 lg:hidden shadow-sm">
            <button onclick="toggleSidebar()" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-black shadow-lg">章节菜单</button>
            <h1 class="font-black text-slate-700 truncate px-4 text-sm" id="mobileHeaderTitle">加载中...</h1>
        </header>

        <div class="p-4 lg:p-12 max-w-4xl mx-auto w-full">
            <div class="hidden lg:flex justify-between items-center mb-10">
                <h2 id="currentTitle" class="text-3xl font-black text-slate-900 tracking-tighter">请选择章节</h2>
                <div class="flex bg-white p-1.5 rounded-2xl shadow-sm border border-slate-200">
                    <button onclick="setMode('normal')" id="nBtn" class="px-8 py-2.5 rounded-xl text-sm font-black bg-blue-600 text-white transition-all shadow-md">浏览模式</button>
                    <button onclick="setMode('review')" id="rBtn" class="px-8 py-2.5 rounded-xl text-sm font-black text-slate-400 transition-all">复习模式</button>
                </div>
            </div>

            <div id="vocabList" class="space-y-8 pb-40">
                </div>
        </div>
    </main>

    <script>
        let allData = [];
        let masteredWords = new Set();
        let isReviewMode = false;
        let currentChapter = "";
        let viewType = "todo"; 

        async function init() {
            const saved = localStorage.getItem('vocab_sync_v6');
            if (saved) {
                try {
                    const p = JSON.parse(saved);
                    masteredWords = new Set(p.mastered || []);
                    currentChapter = p.lastChapter || "";
                    viewType = p.lastViewType || "todo";
                } catch(e) {}
            }

            try {
                const res = await fetch('vocab.json');
                allData = await res.json();
                const chapters = [...new Set(allData.map(d => d.chapter))];
                if (!currentChapter) currentChapter = chapters[0];
                renderStats();
                loadChapter(currentChapter, viewType);
                updateTotalProgress();
            } catch (e) {
                document.getElementById('vocabList').innerHTML = `<div class="p-10 text-center bg-white rounded-3xl border-2 border-dashed">无法加载 vocab.json</div>`;
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('hidden');
        }

        function renderStats() {
            const groups = [...new Set(allData.map(d => d.chapter))];
            const container = document.getElementById('chapterStats');
            container.innerHTML = groups.map(ch => {
                const list = allData.filter(d => d.chapter === ch);
                const mCount = list.filter(d => masteredWords.has(d.word)).length;
                const tCount = list.length - mCount;
                const isActive = ch === currentChapter;
                return `
                <div class="chapter-card p-4 rounded-[1.5rem] border-2 transition-all bg-white ${isActive ? 'active border-blue-500 shadow-xl' : 'border-transparent shadow-sm'}">
                    <div class="font-black text-slate-800 text-lg mb-4 ml-1">${ch}</div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="loadChapter('${ch}', 'todo')" class="flex flex-col items-center py-4 rounded-2xl transition-all ${viewType==='todo' && isActive ? 'bg-blue-600 text-white shadow-lg' : 'bg-blue-50 text-blue-600'}">
                            <span class="text-xl font-black">${tCount}</span>
                            <span class="text-[10px] font-bold uppercase opacity-80">待学习</span>
                        </button>
                        <button onclick="loadChapter('${ch}', 'mastered')" class="flex flex-col items-center py-4 rounded-2xl transition-all ${viewType==='mastered' && isActive ? 'bg-emerald-600 text-white shadow-lg' : 'bg-emerald-50 text-emerald-600'}">
                            <span class="text-xl font-black">${mCount}</span>
                            <span class="text-[10px] font-bold uppercase opacity-80">已掌握</span>
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        function loadChapter(ch, type) {
            currentChapter = ch;
            viewType = type;
            saveProgress();
            renderStats();
            updateTotalProgress();
            const titleStr = `${ch} · ${type === 'todo' ? '待学习' : '已掌握'}`;
            document.getElementById('mobileHeaderTitle').innerText = titleStr;
            const list = allData.filter(d => d.chapter === ch && (type === 'todo' ? !masteredWords.has(d.word) : masteredWords.has(d.word)));
            renderList(list);
            document.getElementById('scrollContainer').scrollTop = 0;
            if (window.innerWidth < 1024) toggleSidebar(); 
        }

        function renderList(data) {
            const container = document.getElementById('vocabList');
            if (data.length === 0) {
                container.innerHTML = `<div class="py-24 text-center text-slate-400 font-black italic bg-white rounded-[3rem] border-2 border-dashed mx-2">全部清空！</div>`;
                return;
            }
            container.innerHTML = data.map(item => {
                const isM = masteredWords.has(item.word);
                return `
                <div id="card-${item.word}" class="bg-white rounded-[3rem] shadow-2xl shadow-slate-300/40 border border-white overflow-hidden">
                    <div class="p-8 md:p-12">
                        <div class="flex justify-between items-start mb-10">
                            <div class="flex-1">
                                <h3 class="text-5xl font-black text-slate-900 tracking-tighter">${item.word}</h3>
                                <div class="text-blue-600 font-mono text-2xl mt-3 font-bold">${item.phonetic || ''}</div>
                            </div>
                            <button onclick="handleMastery('${item.word}')" class="shrink-0 ml-4">
                                <div class="w-20 h-20 rounded-[2rem] border-4 flex items-center justify-center transition-all ${isM ? 'bg-emerald-500 border-emerald-500 text-white' : 'bg-slate-50 text-slate-200'}">
                                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"></path></svg>
                                </div>
                            </button>
                        </div>
                        <div class="blur-content space-y-8" onclick="this.classList.toggle('active')">
                            <div class="bg-slate-900 text-white p-8 rounded-[2.5rem]">
                                <p class="text-xs text-slate-500 font-black mb-3">中文解释</p>
                                <p class="text-4xl font-black leading-tight">${item.meaning_cn || ''}</p>
                            </div>
                            <p class="text-2xl font-bold text-slate-700 leading-relaxed">${item.definition_en || ''}</p>
                            <div class="bg-blue-50/50 p-8 rounded-[2.5rem] border-l-[16px] border-blue-400">
                                <p class="text-2xl italic text-slate-800 leading-relaxed">"${item.sentence_en || ''}"</p>
                                <p class="text-xl text-blue-600 font-black mt-6 text-right">— ${item.sentence_cn || ''}</p>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function handleMastery(word) {
            const card = document.getElementById(`card-${word}`);
            if (viewType === 'todo') {
                card.classList.add('card-mastered-anim');
                setTimeout(() => {
                    masteredWords.add(word);
                    saveProgress();
                    loadChapter(currentChapter, viewType);
                }, 500);
            } else {
                masteredWords.delete(word);
                saveProgress();
                loadChapter(currentChapter, viewType);
            }
        }

        // 智能同步功能：读取剪切板
        async function syncPasteSmart() {
            try {
                // 尝试直接从剪切板读取
                const text = await navigator.clipboard.readText();
                if (text && text.length > 20) {
                    applyCode(text);
                } else {
                    throw new Error("剪切板内容为空或格式不对");
                }
            } catch (err) {
                // 如果权限受限，回退到弹窗模式
                const code = prompt("无法自动读取剪切板，请在此粘贴同步码：");
                if (code) applyCode(code);
            }
        }

        function applyCode(code) {
            try {
                const p = JSON.parse(decodeURIComponent(escape(atob(code))));
                masteredWords = new Set(p.mastered);
                currentChapter = p.lastChapter;
                viewType = p.lastViewType || "todo";
                saveProgress();
                location.reload();
            } catch(e) { alert("同步码无效"); }
        }

        function saveProgress() {
            localStorage.setItem('vocab_sync_v6', JSON.stringify({
                mastered: [...masteredWords], lastChapter: currentChapter, lastViewType: viewType
            }));
        }

        function updateTotalProgress() {
            const percent = (masteredWords.size / allData.length * 100).toFixed(1);
            document.getElementById('totalBar').style.width = percent + '%';
        }

        function setMode(m) {
            isReviewMode = (m === 'review');
            document.getElementById('vocabList').classList.toggle('review-mode', isReviewMode);
            const activeS = "px-8 py-2.5 rounded-xl text-sm font-black bg-blue-600 text-white shadow-md";
            const inactiveS = "px-8 py-2.5 rounded-xl text-sm font-black text-slate-400";
            document.getElementById('nBtn').className = m === 'normal' ? activeS : inactiveS;
            document.getElementById('rBtn').className = m === 'review' ? activeS : inactiveS;
        }

        function syncCopy() {
            const data = btoa(unescape(encodeURIComponent(JSON.stringify({
                mastered: [...masteredWords], lastChapter: currentChapter, lastViewType: viewType
            }))));
            navigator.clipboard.writeText(data).then(() => alert("已复制到剪切板！"));
        }

        init();
    </script>
</body>
</html>
